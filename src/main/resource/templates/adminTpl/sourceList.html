<!doctype html>
<html class="no-js" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
  <title>H5DS 后台系统</title>
  <meta name="description" content="史上最强HTML5编辑器"/>
  <meta name="keywords" content="index"/>
  <!--公用的 css -->
  <div th:replace="@{adminTpl/comm/comm}"></div>
  <!--引入CSS-->
  <link rel="stylesheet" type="text/css" href="/publicStatic/h5ds/styles/style.css"/>
  <!--引入JS-->
  <script src="/publicStatic/h5ds/scripts/plugin.min.js"></script>
</head>
<body>

<div th:replace="@{adminTpl/comm/head}"></div>

<div class="am-cf admin-main">
  
  <!-- sidebar start -->
  <div th:replace="@{adminTpl/comm/nav}"></div>

<!-- content start -->
  <div class="admin-content">

    <div class="am-cf am-padding">
      <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">素材管理</strong> / <small>图片素材</small></div>
    </div>

    <div class="am-g">
      <div class="am-u-sm-12 am-u-md-8">
        <div class="am-btn-toolbar">
          <div class="am-btn-group am-btn-group-xs">
            <button data-am-modal="{target: '#add-source', closeViaDimmer: 0, width: 1000, height: 500}" type="button" class="am-btn am-btn-success"><span class="am-icon-plus"></span> 新增素材</button>
            <button data-am-modal="{target: '#add-sourceType', closeViaDimmer: 0, width: 600, height: 400}" type="button" class="am-btn am-btn-warning"><span class="am-icon-plus"></span> 新增分类</button>
          </div>
        </div>
      </div>
      <div class="am-u-sm-12 am-u-md-2 am-u-offset-2 am-form">
        <div class="am-form-group">
          <select id="sourcetype-select">
            <option th:each="datas:${list}" th:value="${datas.id}" th:text="${datas.sourceTypeName}"></option>
          </select>
        </div>
      </div>
    </div>

    <ul class="am-avg-lg-16 am-margin gallery-list">

      <li class="item2">
        <a href="#">
          <img class="am-img-thumbnail am-img-bdrs" src="http://s.amazeui.org/media/i/demos/bing-1.jpg" alt=""/>
          <div class="gallery-title">
            <span class="am-badge am-badge-secondary">类型名称</span>
            <div class="am-dropdown" style="float:right;" data-am-dropdown="data-am-dropdown">
              <button class="am-btn am-btn-default am-btn-xs am-dropdown-toggle" data-am-dropdown-toggle="data-am-dropdown-toggle"><span class="am-icon-cog"></span> <span class="am-icon-caret-down"></span></button>
              <ul class="am-dropdown-content">
                <!-- <li><a class="set-to-case" href="javascript:;">修改</a></li> -->
                <li><a href="javascript:;">删除</a></li>
              </ul>
            </div>
          </div>
        </a>
      </li>
     
    </ul>

    <div class="am-margin am-cf">
      <hr/>
      <p class="am-fl">共 <span id="s-totalSources"></span> 条记录</p>
      <ol class="am-pagination am-fr" id="s-pageList">
      </ol>
    </div>

  </div>
  <!-- content end -->

</div>

 <div th:replace="@{adminTpl/comm/foot}"></div>
 
<!--添加素材-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="add-source">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">添加素材
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close="data-am-modal-close">&times;</a>
    </div>
    <div class="selecttype-modal">
      <ul class="clearfix">
        <li th:each="data:${list}" th:attr="data-id=${data.id}" th:text="${data.sourceTypeName}"></li>
      </ul>
    </div>
    <div class="am-modal-bd">
       <!--dom结构部分-->
        <div id="uploader-demo" style="text-align:initial; max-height:450px; overflow:auto;">
            <!--图片上传-->
            <div id="upResources"></div>
            <div class="img_resources_box">
                <ul class="clearfix imgResourcesBox"></ul>
            </div>
        </div>
    </div>
  </div>
</div>

 <!--添加分类-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="add-sourceType">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">添加素材分类
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close="data-am-modal-close">&times;</a>
    </div>
    <div class="am-modal-bd">

        <div class="am-g  am-form-group">
          <div class="am-u-sm-8">
            <input type="text" id="add-type-input" style=" width: 400px; height: 42px; border: 1px solid #ddd;" placeholder="输入类型名称" />
          </div>
          <div class="am-u-sm-4">
            <button class="am-btn am-btn-primary" id="add-type-btn">添加</button>
          </div>
        </div>
        <div class="overflow-auto" style="height:280px;">
          <table class="am-table am-table-bordered">
            <tr th:each="data:${list}">
              <td th:text="${data.sourceTypeName}"></td>
              <td>
                <a th:attr="data-id=${data.id}" class="am-btn am-btn-danger delType" href="javascript:;">删除</a>
                <a th:attr="data-id=${data.id}" class="am-btn am-btn-success uploadType" href="javascript:;">修改</a>
                <a th:attr="data-id=${data.id}" style="display:none;" class="am-btn am-btn-primary yesType" href="javascript:;">确认</a>
              </td>
            </tr>
          </table>
        </div>
    </div>
  </div>
</div>

 </body>
<script th:inline="javascript">
/*<![CDATA[>*/

$(function(){
    $(document)
    .on('click', '.delType', function(event) { //删除类型
        var data = {};
        data.sourceTypeId = $(this).attr("data-id");
        //alert("删除素材分类：",data.sourceTypeId);
        $.ajax({
          url: '/admin/deleteSourceType',
          type: 'POST',
          dataType: 'json',
          data: data
        })
        .done(function(msg) {
          //console.log("success");
          if(msg){
            alert("删除成功！");
            location.reload();
          }
        })
        .fail(function() {
          console.log("error");
        })
        .always(function() {
          //console.log("complete");
        });
     
    //更新类型   
    }).on('click', '.uploadType', function(event) {
        var $pre = $(this).parent().prev();
        var str = $pre.html();
        $pre.html('<input type="text" value="'+str+'" />');
        $(this).hide();
        $(this).next(".yesType").show();
    }).on('click', '.yesType', function(event) { //确认修改
        var $pre = $(this).parent().prev();
        var data = {};
        data.sourceTypeId = $(this).attr("data-id");
        data.sourceTypeName = $pre.find("input").val();
        $pre.html(data.sourceTypeName);
        $.ajax({
          url: '/admin/updateSourceType',
          type: 'POST',
          dataType: 'json',
          data: data
        })
        .done(function(msg) {
          //console.log("success");
          if(msg){
            alert("修改成功！");
            location.reload();
          }
        })
        .fail(function() {
          console.log("error");
        })
        .always(function() {
          //console.log("complete");
        });
        
    });
});

$(function(){

    var sourceTypeId = 2;
    // 初始化Web Uploader
    var uploadImgs = function(){

        $("#upResources").html("");

        var $imgResourcesBox = $(".imgResourcesBox");
        
        $("#upResources").zyUpload({
          width            :   "100%",                 // 宽度
          height           :   "auto",                 // 高度
          itemWidth        :   "120px",                 // 文件项的宽度
          itemHeight       :   "100px",                 // 文件项的高度
          url              :   "/upload/systemSource?sourceTypeId="+sourceTypeId,  // 上传文件的路径
          multiple         :   true,                    // 是否可以多个文件上传
          dragDrop         :   true,                    // 是否可以拖动上传文件
          del              :   true,                    // 是否可以删除文件
          finishDel        :   true,            // 是否在上传文件完成后删除预览
          /* 外部获得的回调接口 */
          onSelect: function(files, allFiles){                    // 选择文件的回调方法
    //        console.log("当前选择了以下文件：");
    //        console.log(files);
    //        for(a in files){
    //          console.log(files[a].size); 
    //          if(files[a].size > 1024*500){
    //            alert("您上传的图片大于500KB，请修改"); 
    //          }
    //        }
      //      console.log("之前没上传的文件：");
      //      console.log(allFiles);
          },
          onDelete: function(file, surplusFiles){                     // 删除一个文件的回调方法
      //      console.log("当前删除了此文件：");
      //      console.log(file);
      //      console.log("当前剩余的文件：");
      //      console.log(surplusFiles);
          },
          onSuccess: function(file,response){                    // 文件上传成功的回调方法
            //console.info("此文件上传成功：");
            //console.log(file);
            //console.log("上传的路径是：",response);
            response = eval("("+response+")");
            //console.log(response);
            $imgResourcesBox.append('<li><a href="javascript:void(0)" class="del" data-id="'+response[0].id+'"><i class="fa fa-close"></i></a><img realsize="'+response[0].width+','+response[0].height+'" src="'+response[0].filePath+'"></li>');
              
          },
          onFailure: function(file){                    // 文件上传失败的回调方法
            //console.log("此文件上传失败：");
      //      console.log(file);
          },
          onComplete: function(responseInfo){           // 上传完成的回调方法
            console.log("文件上传完成");
            //console.log(responseInfo);
            window.location.reload();
          }
        });
        
      };uploadImgs();

      //下拉弹窗
      $(document).on("click",".am-dropdown",function(){
          var $dropdown = $(this).find('.am-dropdown-content');
          if($dropdown.is(":visible")){
            $dropdown.hide();
          }else{
            $dropdown.show();
          }
      });

      $(".selecttype-modal").find('li').on("click",function(){
          $(this).addClass('active').siblings().removeClass('active');
          sourceTypeId = $(this).attr("data-id");
          uploadImgs();
      });

      //上传图片默认选中第一个分类
      $(".selecttype-modal").find('li').eq(0).trigger("click");

    //获取资源
    var getSourceData = function(typeId,currentPage){
      console.log(currentPage);
        $.ajax({
          url:'/admin/findSystemSource',
          type:'post',
          data:{sourceTypeId:typeId,currentPage:currentPage},
          success:function(msg){
            //console.log(msg);

            //渲染分页
            $("#s-totalSources").html(msg.totalApps);
            var pHtml = '<li class="prev"><a data-typeid="'+typeId+'" href="javascript:;">«</a></li>';
            for(var i=0; i<msg.totalPages; i++){
                if(i == currentPage){
                  pHtml+='<li class="yema am-active"><a data-typeid="'+typeId+'" href="javascript:;">'+(i+1)+'</a></li>';
                }else{
                  pHtml+='<li class="yema"><a data-typeid="'+typeId+'" href="javascript:;">'+(i+1)+'</a></li>';
                }
            }
            pHtml += '<li class="next"><a data-typeid="'+typeId+'" href="javascript:;">»</a></li>';
            $("#s-pageList").html(pHtml);

            //渲染数据
            var shtml = "";
            var type = $("#sourcetype-select").val();
            for(var i=0; i<msg.returnList.length; i++){
               // msg.returnList[i].sourcePath;
                shtml+='<li class="item2">\
                          <a href="javascript:;" class="imgbox">\
                            <img class="am-img-thumbnail am-img-bdrs" src="'+msg.returnList[i].cutPath+'" alt="">\
                            </a><div class="gallery-title"><a href="javascript:;">\
                              <span class="am-badge am-badge-secondary">类型ID:'+type+'</span>\
                              </a><div class="am-dropdown" style="float:right;" data-am-dropdown="data-am-dropdown"><a href="#">\
                                <button class="am-btn am-btn-default am-btn-xs am-dropdown-toggle"><span class="am-icon-cog"></span> <span class="am-icon-caret-down"></span></button>\
                                </a><ul class="am-dropdown-content"><a href="#">\
                                  </a><li><a href="#"></a><a data-id="'+msg.returnList[i].id+'" class="delsc" href="javascript:;">删除</a></li>\
                                </ul>\
                              </div>\
                            </div>\
                        </li>';
            }
            $(".gallery-list").html(shtml);
          }
        });//end ajax
    };getSourceData(2,0);

    //页面切换
    var changePage = function(){
      $("#s-pageList").on('click', 'li', function(event) {
           var $this = $(this);
           var $thisA = $(this).find("a");
           var className = $(this)[0].className;
           var nowPage = $("#s-pageList").find(".am-active a").html();

          // console.log(nowPage);

           //类型id
           var typeId = $thisA.attr("data-typeid");

           //上一页
           if(className.indexOf("prev") != -1){
              if(nowPage == "1"){
                  return false;
              }else{
                  getSourceData(typeId,(nowPage-2));
                  return false;
              }
           }

           //下一页
           if(className.indexOf("next") != -1){
              if(nowPage == $(".yema").length){
                  return false;
              }else{
                  getSourceData(typeId,(nowPage));
                  return false;
              }
           }

           //直接切换
           if(className.indexOf("yema") != -1){
              getSourceData(typeId, $thisA.html()-1 );
           }

      });
    };changePage();


    //添加素材分类 addSourceType
    $("#add-type-btn").on('click', function(event) {
        var typeName = $("#add-type-input").val();
        if(typeName != ""){
            $.ajax({
              url:'/admin/addSourceType',
              type:'post',
              data:{sourceTypeName:typeName},
              success:function(msg){
                //console.log(msg);
                //数据渲染
                if(msg){
                  location.reload();
                }
              }
            });//end ajax
        }
    });

    //选择素材
    $("#sourcetype-select").on('change', function(event) {
        var typeId = $(this).val();
        getSourceData(typeId,0);
    });

    //删除素材
    $(document).on('click', '.delsc', function(event) {
        var id = $(this).attr("data-id");
        $.ajax({
          url:'/admin/deleteSource',
          type:'post',
          data:{sourceId:id},
          success:function(msg){
            if(msg){
              alert("删除成功！");
              location.reload();
            }
          }
        });
    });
  
});
/*]]>*/   
</script>
</html>
